<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-fastdom-import/fastdom.html">
<link rel="import" href="../d2l-polymer-behaviors/d2l-focusable-behavior.html">
<link rel="import" href="../d2l-button/d2l-button-icon.html">
<link rel="import" href="../d2l-text-input/d2l-text-input-shared-styles.html">
<link rel="import" href="localize-behavior.html">

<!--
`d2l-search-input`
Polymer-based web components for search

@demo demo/index.html
-->

<dom-module id="d2l-search-input">

	<template strip-whitespace>
		<style>

			:host {
				display: inline-block;
				width: 100%
			}

			.d2l-search-input-container {
				position: relative;
			}

			input {
				font-family: inherit;
				@apply --d2l-input;
				padding-right: 2.4rem;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}

			:host-context([dir="rtl"]) input {
				padding-right: 0.75rem;
				padding-left: 2.4rem;
			}

			/* Duplicated because some browsers ignore CSS block for any invalid selector */
			:host(:dir(rtl)) input {
				padding-right: 0.75rem;
				padding-left: 2.4rem;
			}

			input::placeholder {
				@apply --d2l-input-placeholder;
			}

			input:disabled {
				@apply --d2l-input-disabled;
			}

			input:hover:disabled {
				@apply --d2l-input-disabled-hover;
			}

			input:hover,
			input:focus,
			.d2l-search-input-hover input,
			.d2l-search-input-focus input {
				@apply --d2l-input-hover;
				padding-right: calc(2.4rem - 1px);
			}

			:host-context([dir="rtl"]) input:hover,
			:host-context([dir="rtl"]) input:focus,
			:host-context([dir="rtl"]) .d2l-search-input-hover input,
			:host-context([dir="rtl"]) .d2l-search-input-focus input {
				padding-right: calc(0.75rem - 1px);
				padding-left: calc(2.4rem - 1px);
			}

			:host(:dir(rtl)) input:hover,
			:host(:dir(rtl)) input:focus,
			:host(:dir(rtl)) .d2l-search-input-hover input,
			:host(:dir(rtl)) .d2l-search-input-focus input {
				padding-right: calc(0.75rem - 1px);
				padding-left: calc(2.4rem - 1px);
			}

			d2l-button-icon {
				--d2l-button-icon-min-height: 1.7rem;
				--d2l-button-icon-min-width: 1.7rem;
				--d2l-button-icon-border-radius: 4px;
				position: absolute;
				height: 1.7rem;
				width: 1.7rem;
				top: 0.2rem;
				right: 0.2rem;
			}

			:host-context([dir="rtl"]) d2l-button-icon {
				left: 0.2rem;
				right: auto;
			}

			:host(:dir(rtl)) d2l-button-icon {
				left: 0.2rem;
				right: auto;
			}

			d2l-button-icon[hidden] {
				display: none;
			}

		</style>
		<div role="search" class="d2l-search-input-container">
			<input
				aria-label$="[[label]]"
				class="d2l-focusable"
				disabled$="[[disabled]]"
				on-keypress="_handleInputKeyPress"
				placeholder$="[[placeholder]]"
				type="text" />
			<d2l-button-icon
				class="d2l-search-input-search"
				disabled$="[[disabled]]"
				hidden=[[value]]
				icon="d2l-tier1:search"
				on-click="_handleSearchClick"
				text="[[localize('search')]]"></d2l-button-icon>
			<d2l-button-icon
				class="d2l-search-input-clear"
				disabled$="[[disabled]]"
				hidden=[[!value]]
				icon="d2l-tier1:close-default"
				on-click="_handleClearClick"
				text="[[localize('search.clear')]]"></d2l-button-icon>
		</div>
	</template>

	<script>
		Polymer({
			is: 'd2l-search-input',

			behaviors: [
				D2L.PolymerBehaviors.FocusableBehavior,
				D2L.PolymerBehaviors.Search.LocalizeBehavior
			],

			properties: {
				/**
				 * Whether the input is disabled.
				 */
				disabled: {
					type: Boolean,
					reflectToAttribute: true,
					value: false
				},
				/**
				 * Accessible label to be applied to the input.
				 */
				label: {
					type: String
				},
				/**
				 * A hint to the user of what can be entered in the input.
				 */
				placeholder: {
					type: String
				},
				/**
				 * Value of the input.
				 */
				value: {
					type: String,
					notify: true,
					reflectToAttribute: true
				}
			},

			_keyCodes: {
				ENTER: 13
			},

			ready: function() {
				this._handleFocus = this._handleFocus.bind(this);
				this._handleBlur = this._handleBlur.bind(this);
				this._handleMouseEnter = this._handleMouseEnter.bind(this);
				this._handleMouseLeave = this._handleMouseLeave.bind(this);
			},

			attached: function() {
				Polymer.dom(this.root).querySelector('input').value = this.value;
				Polymer.RenderStatus.afterNextRender(this, function() {
					var elem = this._getContainer();
					elem.addEventListener('focus', this._handleFocus, true);
					elem.addEventListener('blur', this._handleBlur, true);
					elem.addEventListener('mouseenter', this._handleMouseEnter, true);
					elem.addEventListener('mouseleave', this._handleMouseLeave, true);
				});
			},

			detached: function() {
				var elem = this._getContainer();
				elem.removeEventListener('focus', this._handleFocus, true);
				elem.removeEventListener('blur', this._handleBlur, true);
				elem.removeEventListener('mouseenter', this._handleMouseEnter, true);
				elem.removeEventListener('mouseleave', this._handleMouseLeave, true);
			},

			_dispatchSearchEvent: function(value) {
				this.dispatchEvent(new CustomEvent(
					'd2l-search-input-search',
					{bubbles: true, composed: false, detail: {value: value}}
				));
			},

			_dispatchClearEvent: function() {
				this.dispatchEvent(new CustomEvent(
					'd2l-search-input-clear',
					{bubbles: true, composed: false, detail: {value: ''}}
				));
			},

			_getContainer: function() {
				return Polymer.dom(this.root).querySelector('.d2l-search-input-container');
			},

			_handleBlur: function(e) {
				if (this._isFocusableChild(e.relatedTarget)) return;
				fastdom.mutate(function() {
					this._getContainer().classList.remove('d2l-search-input-focus');
				}.bind(this));
			},

			_handleClearClick: function() {
				fastdom.mutate(function() {
					var input = Polymer.dom(this.root).querySelector('input');
					input.value = '';
					this.value = '';
					fastdom.measure(function() {
						fastdom.mutate(function() {
							input.focus();
						});
					});
					this._dispatchClearEvent();
				}.bind(this));
			},

			_handleFocus: function() {
				fastdom.mutate(function() {
					this._getContainer().classList.add('d2l-search-input-focus');
				}.bind(this));
			},

			_handleInputKeyPress: function(e) {
				if (e.keyCode !== this._keyCodes.ENTER) {
					return;
				}
				var value = e.target.value;
				fastdom.mutate(function() {
					this.value = value;
					if (value.length > 0) {
						this._dispatchSearchEvent(value);
					} else {
						this._dispatchClearEvent();
					}
				}.bind(this));
			},

			_handleMouseEnter: function() {
				fastdom.mutate(function() {
					this._getContainer().classList.add('d2l-search-input-hover');
				}.bind(this));
			},

			_handleMouseLeave: function(e) {
				if (this._isFocusableChild(e.relatedTarget)) return;
				fastdom.mutate(function() {
					this._getContainer().classList.remove('d2l-search-input-hover');
				}.bind(this));
			},

			_handleSearchClick: function() {
				fastdom.mutate(function() {
					var input = Polymer.dom(this.root).querySelector('input');
					this.value = input.value;
					if (this.value.length > 0) {
						Polymer.dom(this.root).querySelector('.d2l-search-input-clear').focus();
						this._dispatchSearchEvent(this.value);
					} else {
						this._dispatchClearEvent();
					}
				}.bind(this));
			},

			_isFocusableChild: function(elem) {
				return (elem === Polymer.dom(this.root).querySelector('input')
					|| elem === Polymer.dom(this.root).querySelector('.d2l-search-input-search')
					|| elem === Polymer.dom(this.root).querySelector('.d2l-search-input-clear'));
			}

		});
	</script>

</dom-module>
